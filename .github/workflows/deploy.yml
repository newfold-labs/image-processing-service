name: Deploy to DO

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.DROPLET_HOST }}
        username: ${{ secrets.DROPLET_USER }}
        password: ${{ secrets.DROPLET_PASSWORD }}
        key: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}
        script: |
          # Set variables
          PROJECT_DIR="/home/deploy/image-processing-api"
          REPO_URL="https://github.com/${{ github.repository }}.git"
          
          # Show current deployment info
          echo "ğŸ”„ Starting deployment..."
          echo "ğŸ“‚ Target directory: $PROJECT_DIR"
          echo "ğŸ“‹ Repository: $REPO_URL"
          
          # Create and setup project directory
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ğŸ“ Creating project directory..."
            mkdir -p "$PROJECT_DIR"
            echo "ğŸ“¥ Cloning repository..."
            git clone "$REPO_URL" "$PROJECT_DIR"
          else
            echo "ğŸ“‚ Project directory exists, updating..."
          fi
          
          # Navigate to project directory
          cd "$PROJECT_DIR"
          
          # Show current deployment info
          echo "ğŸŒ¿ Current branch: $(git branch --show-current 2>/dev/null || echo 'detached')"
          echo "ğŸ“‹ Current commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'none')"
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Show new deployment info
          echo "âœ… Updated to commit: $(git rev-parse --short HEAD)"
          
          # Create/update .env file with production values
          echo "âš™ï¸ Updating environment configuration..."
          cat > .env << EOF
          API_AUTH_TOKEN=${{ secrets.API_AUTH_TOKEN }}
          APP_ENV=production
          LOG_LEVEL=info
          DEPLOYMENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DEPLOYMENT_SHA=${{ github.sha }}
          EOF
          
          # Deploy with Docker Compose
          echo "ğŸ³ Stopping existing containers..."
          docker-compose down 2>/dev/null || echo "No containers to stop"
          
          echo "ğŸ—ï¸ Building and starting new containers..."
          docker-compose up --build -d
          
          # Wait for containers to start
          echo "â³ Waiting for containers to start..."
          sleep 15
          
          # Show container status
          echo "ğŸ“Š Container status:"
          docker-compose ps
          
          # Test the deployment
          echo "ğŸ©º Testing deployment..."
          for i in {1..5}; do
            if curl -f http://localhost:8000/; then
              echo "âœ… Health check passed!"
              break
            else
              echo "âš ï¸ Health check failed, attempt $i/5"
              sleep 5
            fi
          done
          
          # Show container logs (last 20 lines)
          echo "ğŸ“‹ Recent container logs:"
          docker-compose logs --tail=20
          
          # Restart nginx to ensure everything is connected (with error handling)
          echo "ğŸ”„ Reloading nginx..."
          if sudo systemctl reload nginx 2>/dev/null; then
            echo "âœ… Nginx reloaded successfully"
          else
            echo "âš ï¸ Could not reload nginx (may need sudo configuration)"
          fi
          
          echo ""
          echo "ğŸ‰ Deployment completed successfully!"